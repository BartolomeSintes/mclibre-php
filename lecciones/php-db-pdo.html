<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>PHP Data Objects (PDO). PHP. Bartolomé Sintes Marco. www.mclibre.org</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../varios/php.css" title="mclibre">
  <link rel="icon" href="../varios/favicon.svg">
  <link rel="stylesheet" href="../varios/prism.css">
  <script src="../varios/prism.js"></script>
</head>

<body>
  <h1>PHP Data Objects (PDO)</h1>

  <nav>
    <p>
      <a href="../index.html"><img src="../varios/iconos/icono-php.svg" alt="Índice de PHP" title="Índice de PHP" width="48" height="48"></a>
      <a href="#"><img src="../varios/iconos/icono-arrow-circle-up.svg" alt="Principio de la página" title="Principio de la página" width="36" height="36"></a>
    </p>

    <div class="toc">
      <h2>PHP Data Objects (PDO)</h2>

      <ul>
        <li><a href="#conexion">Conexión</a>
          <ul>
            <li><a href="#conexion-mysql">con MySQL</a></li>
            <li><a href="#conexion-sqlite">con SQLite 3</a></li>
            <li><a href="#conexion-configurable">configurable</a></li>
          </ul>
        </li>
        <li><a href="#desconexion">Desconexión</a></li>
        <li><a href="#consultas">Consultas a la base de datos</a></li>
        <li><a href="#seguridad">Seguridad en las consultas</a>
          <ul>
            <li><a href="#consultas-preparadas">Consultas preparadas</a></li>
            <li><a href="#restricciones">Restricciones en parámetros</a></li>
          </ul>
        </li>
        <li><a href="#ejemplos">Ejemplos de consultas</a>
          <ul>
            <li><a href="#create">CREATE DATABASE, DROP DATABASE, CREATE TABLE</a>
              <ul>
                <li><a href="#create-mysql">en MySQL</a></li>
                <li><a href="#create-sqlite">en SQLite</a></li>
                <li><a href="#create-configurable">configurable</a></li>
              </ul>
            </li>
            <li><a href="#drop">DROP TABLE, INSERT INTO, UPDATE, DELETE FROM</a></li>
            <li><a href="#select">SELECT</a></li>
            <li><a href="#select-like">SELECT LIKE</a></li>
            <li><a href="#union-tablas">unión de tablas</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </nav>

  <p>La extensión <a href="https://www.php.net/manual/en/book.pdo.php">PDO (PHP Data Objects)</a> permite acceder a distintas bases de datos utilizando las misma funciones, lo que facilita la portabilidad. En PHP 5 existen drivers para acceder a las bases de datos más populares (MySQL, Oracle, MS SQL Server, PostgreSQL, SQLite, Firebird, DB2, Informix, etc). La extensión PDO no evalúa la corrección de las consultas SQL, aunque sí implementa algunas medidas de seguridad mediante las consultas preparadas.</p>

  <p>En esta lección se explica el acceso a MySQL y SQLite mediante PDO.</p>

  <section id="conexion">
    <h2>Conexión con la base de datos</h2>

    <p>Para conectar con la base de datos hay que crear una instancia de la clase PDO, que se utiliza en todas las consultas posteriores. En cada página php que incluya consultas a la base de datos es necesario conectar primero con la base de datos.</p>

    <p>Si no se puede establecer la conexión con la base de datos, puede deberse a que la base de datos no esté funcionando, a que los datos de usuario no sean correctos, a que no esté activada la extensión pdo o (en el caso de SQLite) que no exista el camino donde se guarda la base de datos.</p>

    <section id="conexion-mysql">
      <h3>Conexión con MySQL</h3>

      <p>En el caso de MySQL, para crear el objeto PDO se necesita proporcionar el nombre del servidor, el nombre de usuario y la contraseña. En el ejemplo siguiente esos datos se proporcionan como constantes que deberían definirse en el programa.</p>

      <p>Para poder acceder a MySQL mediante PDO, debe estar activada la extensión php_pdo_mysql en el archivo de configuración php.ini (véase el <a href="../otros/php-configuracion-1.html#pdo-mysql">apartado extensión pdo_mysql en la lección de configuración de Apache y PHP</a>).</p>

      <div class="codigo">
        <pre>
<code class="language-php">// FUNCIÓN DE CONEXIÓN CON LA BASE DE DATOS MYSQL
function conectaDb()
{
    try {
        $tmp = new PDO(MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD);
        $tmp-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, true);
        $tmp-&gt;exec("set names utf8mb4");
        return $tmp;
    } catch (PDOException $e) {
        cabecera("Error grave", MENU_PRINCIPAL);
        print "    &lt;p class=\"aviso\"&gt;Error: No puede conectarse con la base de datos.&lt;/p&gt;\n";
        print "\n";
        print "    &lt;p class=\"aviso\"&gt;Error: " . $e-&gt;getMessage() . "&lt;/p&gt;\n";
        pie();
        exit;
    }
}

// EJEMPLO DE USO DE LA FUNCIÓN conectaDB()
// La conexión se debe realizar en cada página que acceda a la base de datos
$db = conectaDB();</code>
</pre>
      </div>
    </section>

    <section id="conexion-sqlite">
      <h3>Conexión con SQLite 3</h3>

      <p>En SQLite, no se hace una conexión a un servidor, sino que simplemente se indica el archivo que va a contener la base de datos. En SQLite no hay un servidor que gestiona todas las bases de datos, sino que cada base de datos es un archivo independiente (que debe estar situado en un directorio que exista y en el que el servidor web tenga permisos de escritura).</p>

      <p>Para poder utilizar SQLite mediante PDO, debe estar activada la extensión php_pdo_sqlite en el archivo de configuración php.ini (véase el <a href="../otros/php-configuracion-1.html#pdo-sqlite">apartado extensión pdo_sqlite en la lección de configuración de Apache y PHP</a>).</p>

      <div class="codigo">
        <pre>
<code class="language-php">// FUNCIÓN DE CONEXIÓN CON LA BASE DE DATOS SQLITE
function conectaDb()
{
    try {
        $tmp = new PDO("sqlite:" . SQLITE_DATABASE);
        return $tmp;
    } catch (PDOException $e) {
        cabecera("Error grave", MENU_PRINCIPAL);
        print "    &lt;p class=\"aviso\"&gt;Error: No puede conectarse con la base de datos.&lt;/p&gt;\n";
        print "\n";
        print "    &lt;p class=\"aviso\"&gt;Error: " . $e-&gt;getMessage() . "&lt;/p&gt;\n";
        pie();
        exit;
    }
}

// EJEMPLO DE USO DE LA FUNCIÓN conectaDb()
// La conexión se debe realizar en cada página que acceda a la base de datos
$db = conectaDB();</code>
</pre>
      </div>

      <p><strong>Notas</strong>:</p>
      <ul>
        <li>En las soluciones de los ejercicios proporcionadas en estos apuntes, los archivos se guardan en el directorio <strong>/home/barto/mclibre/tmp/mclibre/</strong>. Para que funcionen las soluciones, se debe crear ese directorio o cambiarlo a otro.</li>
        <li>En caso de error, la función conectaDb() genera una página completa (con una cabecera especial, con contenido de mensajes de error y pie) y termina el programa. Por tanto la conexión con la base de datos debe hacerse nada más empezar el programa (antes de generar la cabecera de la página).</li>
      </ul>
    </section>

    <section id="conexion-configurable">
      <h3>Conexión configurable</h3>

      <p>Si se incluyen ambas conexiones en el mismo programa, cada usuario puede elegir la base de datos más conveniente en cada caso.</p>

      <p>En los ejercicios en este curso se propone al alumno organizar los programas de manera que puedan trabajar tanto con SQLite como con MySQL y hacerlo de forma organizada, para que se puedan añadir fácilmente otras bases de datos.</p>

      <p>Para ello se crearán dos bibliotecas, una dedicada a MySQL y otra a SQLite, que contengan las funciones específicas de cada base de datos. Además habrá una biblioteca general en la que se pueda seleccionar la biblioteca a utilizar (MySQL o SQLite). Así, cada página llamará a la biblioteca general y esta llamará a la biblioteca específica.</p>

      <p>Por ejemplo, para el caso de la función de conexión, el resultado sería:</p>
      <ul>
        <li>config.php: en este fichero se especifica la base de datos que se va a utilizar:

          <div class="codigo">
            <pre>
<code class="language-php">// config.php

<span class="codigo-resaltado">$dbMotor = SQLITE</span>;                         // Base de datos empleada (MYSQL o SQLITE)</code>
</pre>
          </div>
        </li>
        <li>en cualquier fichero que quiera conectar con la base de datos se llamaría a la biblioteca general y se llamaría a la función genérica conectaDB():

          <div class="codigo">
            <pre>
<code class="language-php">// EJEMPLO DE USO DE CONEXIÓN CONFIGURABLE
// La conexión se debe realizar en cada página que acceda a la base de datos
require_once "biblioteca.php";
$db = conectaDB();</code>
</pre>
          </div>
        </li>
        <li>biblioteca.php: la configuración establecida en config.php determina la biblioteca específica a cargar:

          <div class="codigo">
            <pre>
<code class="language-php">// biblioteca.php
define("MYSQL",          "MySQL");         // Base de datos MySQL
define("SQLITE",         "SQLite");        // Base de datos SQLITE

require_once "config.php";

if ($dbMotor == MYSQL) {
    require_once "biblioteca-mysql.php";
} elseif ($dbMotor == SQLITE) {
    require_once "biblioteca-sqlite.php";
}</code>
</pre>
          </div>
        </li>
        <li>biblioteca-mysql.php: contiene la definición de la función conectaDB() específica para trabajar con MySQL

          <div class="codigo">
            <pre>
<code class="language-php">// biblioteca-mysql.php
function conectaDb()
{
    try {
        $tmp = new PDO(MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD);
        $tmp-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, true);
        $tmp-&gt;exec("set names utf8mb4");
        return $tmp;
    } catch (PDOException $e) {
        cabecera("Error grave", MENU_PRINCIPAL);
        print "    &lt;p class=\"aviso\"&gt;Error: No puede conectarse con la base de datos.&lt;/p&gt;\n";
        print "\n";
        print "    &lt;p class=\"aviso\"&gt;Error: " . $e-&gt;getMessage() . "&lt;/p&gt;\n";
        pie();
        exit;
    }
}</code>
</pre>
          </div>
        </li>
        <li>biblioteca-sqlite.php: contiene la definición de la función conectaDB() específica para trabajar con SQLite

          <div class="codigo">
            <pre>
<code class="language-php">// biblioteca-sqlite.php
function conectaDb()
{
    try {
        $tmp = new PDO("sqlite:" . SQLITE_DATABASE);
        return $tmp;
    } catch (PDOException $e) {
        cabecera("Error grave", MENU_PRINCIPAL);
        print "    &lt;p class=\"aviso\"&gt;Error: No puede conectarse con la base de datos.&lt;/p&gt;\n";
        print "\n";
        print "    &lt;p class=\"aviso\"&gt;Error: " . $e-&gt;getMessage() . "&lt;/p&gt;\n";
        pie();
        exit;
    }
}</code>
</pre>
          </div>
        </li>
      </ul>
    </section>
  </section>

  <section id="desconexion">
    <h2>Desconexión con la base de datos</h2>

    <p>Para desconectar con la base de datos hay que destruir el objeto PDO. Si no se destruye el objeto PDO, PHP lo destruye al terminar la página.</p>

    <div class="codigo">
      <pre><code class="language-php">$db = null;</code></pre>
    </div>
  </section>

  <section id="consultas">
    <h2>Consultas a la base de datos</h2>

    <p>Una vez realizada la conexión a la base de datos, las operaciones se realizan a través de consultas.</p>

    <p>El método para efectuar consultas es <a href="https://www.php.net/manual/en/pdo.query.php"><span class="php-fun">PDO-&gt;query($consulta)</span></a>, que devuelve el resultado de la consulta. Dependiendo del tipo de consulta, el dato devuelto debe tratarse de formas distintas.</p>
    <ul>
      <li>Si es una consulta que no devuelve registros, sino que simplemente realiza una acción que puede tener éxito o no (por ejemplo, insertar un registro), el método devuelve <span class="php-con">true</span> o <span class="php-con">false</span>. No es necesario guardar el resultado de la consulta en ninguna variable, pero se puede utilizar para sacar un mensaje diciendo que todo ha ido bien (o no). Por ejemplo,

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE INSERCIÓN DE REGISTRO
require_once "biblioteca.php";
$db = conectaDB();

$consulta = "INSERT INTO $tablaAgenda
    (nombre, apellidos)
    VALUES ("$nombre", "$apellidos")";
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Registro creado correctamente.&lt;/p&gt;\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al crear el registro.&lt;p&gt;\n";
}

$db = null;</code>
</pre>
        </div>
      </li>
      <li>Pero si la consulta devuelve registros, el método devuelve los registros correspondientes o <span class="php-con">false</span>. En ese caso sí que es conveniente guardar lo que devuelve el método en una variable para procesarla posteriormente. Si contiene registros, la variable es de un tipo especial llamado <a href="https://www.php.net/manual/en/language.types.resource.php">recurso</a> que no se puede acceder directamente, pero que se puede recorrer con un bucle <span class="php-res">foreach ()</span>,

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
require_once "biblioteca.php";
$db = conectaDB();

$consulta = "SELECT * FROM $tablaAgenda";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
} else {
    foreach ($result as $valor) {
        print "    &lt;p&gt;$valor[nombre] $valor[apellidos]&lt;/p&gt;\n";
    }
}

$db = null;</code>
</pre>
        </div>
      </li>
    </ul>

    <hr class="corta">

    <p>En los ejemplos, se define una variable $consulta que contiene la consulta y a continuación se ejecuta la consulta, pero podría estar en una sola:</p>

    <div class="codigo">
      <pre>
<code class="language-php">// En dos líneas
$consulta = "SELECT * FROM $tablaAgenda";
$result = $db-&gt;query($consulta);

// En una sola línea
$result = $db-&gt;query("SELECT * FROM $tablaAgenda");</code>
</pre>
    </div>

    <p>Se recomienda utilizar la primera versión, que permite por ejemplo imprimir la consulta mientras se está programando para comprobar que no tiene errores:</p>

    <div class="codigo">
      <pre>
<code class="language-php">$consulta = "SELECT * FROM $tablaAgenda";
print "&lt;p&gt;Consulta: $consulta&lt;/p&gt;\n";
$result = $db-&gt;query($consulta);</code>
</pre>
    </div>
  </section>

  <section id="seguridad">
    <h2>Seguridad en las consultas: consultas preparadas</h2>

    <p>Para evitar ataques de inyección SQL (en la lección <a href="php-db-inyeccion-sql.html">Inyecciones SQL</a> se comentan los ataques más elementales), se recomienda el uso de <a href="https://www.php.net/manual/en/pdo.prepared-statements.php">sentencias preparadas</a>, en las que PHP se encarga de "desinfectar" los datos en caso necesario. En general, cualquier consulta que incluya datos introducidos por el usuario debe realizarse mediante consultas preparadas.</p>

    <section id="consultas-preparadas">
      <h3>Consultas preparadas</h3>

      <p>El método para efectuar consultas es primero preparar la consulta con <a href="https://www.php.net/manual/en/pdo.prepare.php"><span class="php-fun">PDO-&gt;prepare($consulta)</span></a> y después ejecutarla con <span class="php-fun"><a href="https://www.php.net/manual/en/pdostatement.execute.php">PDO-&gt;execute([parámetros])</a></span>, que devuelve el resultado de la consulta.</p>

      <div class="codigo">
        <pre>
<code class="language-php">// Consulta preparada
$consulta = "SELECT * FROM $tablaAgenda";
$result = $db-&gt;prepare($consulta);
$result-&gt;execute();</code>
</pre>
      </div>

      <p>Dependiendo del tipo de consulta, el dato devuelto debe tratarse de formas distintas, como se ha explicado en el apartado anterior.</p>

      <hr class="corta">

      <p>Si la consulta incluye datos introducidos por el usuario, los datos pueden incluirse directamente en la consulta, pero en ese caso, PHP no realiza ninguna "desinfección" de los datos, por lo que estaríamos corriendo riesgos de ataques:</p>

      <div class="codigo">
        <pre>
<code class="language-php">$nombre    = $_REQUEST["nombre"];
$apellidos = $_REQUEST["apellidos"];

$consulta = "SELECT COUNT(*) FROM $tablaAgenda
    WHERE <span class="codigo-resaltado">nombre=$nombre</span>
    AND <span class="codigo-resaltado">apellidos=$apellidos</span>";     // DESACONSEJADO: PHP NO DESINFECTA LOS DATOS
$result = $db-&gt;prepare($consulta);
$result-&gt;execute();
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
 ...</code>
</pre>
      </div>

      <hr class="corta">

      <p>Para que PHP desinfecte los datos, estos deben enviarse al ejecutar la consulta, no al prepararla. Para ello es necesario indicar en la consulta la posición de los datos. Esto se puede hacer de dos maneras, mediante parámetros o mediante interrogantes, aunque se aconseja la utilización de parámetros:</p>
      <ul>
        <li>mediante parámetros (:parametro)
          <p>En este caso la matriz debe incluir los nombres de los parámetros y los valores que sustituyen a los parámetros (el orden no es importante), como muestra el siguiente ejemplo:</p>

          <div class="codigo">
            <pre>
<code class="language-php">$nombre    = $_REQUEST["nombre"];
$apellidos = $_REQUEST["apellidos"];

$consulta = "SELECT COUNT(*) FROM $tablaAgenda
    WHERE <span class="codigo-resaltado">nombre=:nombre</span>
    AND <span class="codigo-resaltado">apellidos=:apellidos</span>";
$result = $db-&gt;prepare($consulta);
$result-&gt;<span class="codigo-resaltado">execute([":nombre" =&gt; $nombre, ":apellidos" =&gt; $apellidos])</span>;
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
 ...</code>
</pre>
          </div>
        </li>
        <li>mediantes interrogantes (?)
          <p>En este caso la matriz debe incluir los valores que sustituyen a los interrogantes en el mismo orden en que aparecen en la consulta, como muestra el siguiente ejemplo:</p>

          <div class="codigo">
            <pre>
<code class="language-php">$nombre    = $_REQUEST["nombre"];
$apellidos = $_REQUEST["apellidos"];

$consulta = "SELECT COUNT(*) FROM $tablaAgenda
    WHERE <span class="codigo-resaltado">nombre=?</span>
    AND <span class="codigo-resaltado">apellidos=?</span>";
$result = $db-&gt;prepare($consulta);
$result-&gt;<span class="codigo-resaltado">execute([$nombre, $apellidos])</span>;
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
 ...</code>
</pre>
          </div>
        </li>
      </ul>

      <hr class="corta">

      <p>Aunque no vayan a causar problemas en las consultas, sigue siendo conveniente tratar los datos recibidos para eliminar los espacios en blanco iniciales y finales, tratar los caracteres especiales del html, etc., como se comenta en la <a href="php-recogida-datos.html">lección de Recogida de datos</a>.</p>
    </section>

    <section id="restricciones">
      <h3>Restricciones en los parámetros de consultas preparadas</h3>

      <p>Debido a que las consultas preparadas se idearon para optimizar el rendimiento de las consultas, el uso de parámetros tiene algunas restricciones. Por ejemplo</p>
      <ul>
        <li>los identificadores (nombres de tablas, nombres de columnas, etc) no pueden sustituirse por parámetros</li>
        <li>los dos elementos de una igualdad no pueden sustituirse por parámetros</li>
        <li>en general no pueden utilizarse parámetros en las consultas DDL (lenguaje de definición de datos) (nombre y tamaño de las columnas, etc.)</li>
      </ul>

      <p>Si no podemos usar parámetros, no queda más remedio que incluir los datos en la consulta. Como en ese caso PHP no hace ninguna desinfección de los datos, la tenemos que hacer nosotros previamente.</p>

      <p>Como en estos casos los valores introducidos por el usuario suelen tener unos valores restringidos (por ejemplo, si el usuario puede elegir una columna de una tabla, los nombres de las columnas están determinadas y el usuario sólo puede elegir uno de ellos), podemos crear una función de recogida de datos específica que impida cualquier tipo de ataque de inyección por parte del usuario, como muestra el siguiente ejemplo:</p>

      <div class="codigo">
        <pre>
<code class="language-php">// FUNCIÓN DE RECOGIDA DE UN DATO QUE SÓLO PUEDE TOMAR DETERMINADOS VALORES
$columnas = [
    "nombre",
    "apellidos"
];

function recogeValores($var, $valoresValidos, $valorPredeterminado)
{
    foreach ($valoresValidos as $valorValido) {
        if (isset($_REQUEST[$var]) &amp;&amp; $_REQUEST[$var] == $valorValido) {
            return $valorValido;
        }
    }
    return $valorPredeterminado;
}

// EJEMPLO DE USO DE LA FUNCIÓN ANTERIOR
$columna = recogeValores("columna", $columnas, "apellidos");
$nombre  = $_REQUEST["nombre"];

$consulta = "SELECT * FROM $tablaAgenda
    WHERE nombre=:nombre
    ORDER BY <span class="codigo-resaltado">$columna</span> ASC";
$result = $db-&gt;prepare($consulta);
$result-&gt;<span class="codigo-resaltado">execute([":nombre" =&gt; $nombre])</span>;
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
 ...</code>
</pre>
      </div>
    </section>
  </section>

  <section id="ejemplos">
    <h2>Ejemplos de consultas</h2>

    <p>En los ejemplos de este apartado, se han utilizado sentencias preparadas en los casos en los que las consultas incluyen datos proporcionados por el usuario y consultas no preparadas cuando no incluyan datos proporcionados por el usuario. En la mayoría de los casos se podrían haber utilizado sentencias preparadas aunque no haya datos proporcionados por el usuario.</p>

    <section id="create">
      <h3>Consultas CREATE DATABASE, DROP DATABASE, CREATE TABLE</h3>

      <p>Estas consultas no son iguales en MySQL y SQLite. En los ejercicios propuestos para que se pueda utilizar una u otra base de datos, estas consultas se incluyen en las bibliotecas específicas.</p>
      <ul>
        <li>En el caso de utilizar SQLite, no tiene sentido crear o borrar la base de datos ya que con SQLite cada base de datos es un fichero distinto y al conectar con la base de datos ya se dice con qué archivo se va a trabajar y se crea en caso necesario.</li>
        <li>Para crear una tabla, se utiliza la consulta CREATE TABLE. Las consultas de creación de tabla suelen ser específicas de cada base de datos. Los ejemplos no utilizan sentencias preparadas (en caso de utilizarse sentencias preparadas, las variables no podrían ir como parámetros por tratarse de sentencias DDL).</li>
      </ul>

      <section id="create-mysql">
        <h4>Consultas en MySQL</h4>

        <p>Para crear una base de datos, se utiliza la consulta CREATE DATABASE.</p>

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE CREACIÓN DE BASE DE DATOS EN MYSQL

define(
    "CONSULTA_CREA_DB",
    "CREATE DATABASE " . MYSQL_DATABASE . "
        CHARACTER SET utf8mb4
        COLLATE utf8mb4_unicode_ci"
);

$consulta = CONSULTA_CREA_DB;
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Base de datos creada correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al crear la base de datos.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
        </div>

        <p><strong>Nota</strong>: El juego de caracteres utilizado en este curso es <strong>UTF-8</strong>, por lo que en la base de datos MySQL se utiliza el juego de caracteres <strong>utf8mb4</strong> (que permite almacenar cualquier carácter Unicode) y el cotejamiento <strong>utf8mb4_unicode_ci</strong> (que implementa todos los criterios de ordenación de Unicode). Para una explicación más detallada se puede consultar <a href="https://mathiasbynens.be/notes/mysql-utf8mb4">el blog de Mathias Bynens</a>.</p>

        <p>Para borrar una base de datos, se utiliza la consulta DROP DATABASE.</p>

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE BORRADO DE BASE DE DATOS EN MYSQL

define("CONSULTA_BORRA_DB", "DROP DATABASE " . MYSQL_DATABASE);

$consulta = CONSULTA_BORRA_DB;
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Base de datos borrada correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al borrar la base de datos.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
        </div>

        <p>Para crear una tabla, se utiliza la consulta CREATE TABLE. Las consultas de creación de tabla suelen ser específicas de cada base de datos. El ejemplo no utiliza sentencias preparadas (en caso de utilizarse sentencias preparadas, las variables no podrían ir como parámetros por tratarse de sentencias DDL).</p>

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE CREACIÓN DE TABLA EN MYSQL
$consulta = "CREATE TABLE $tablaAgenda (
    id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
    nombre VARCHAR($tamAgendaNombre),
    apellidos VARCHAR($tamAgendaApellidos),
    PRIMARY KEY(id)
    )";
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Tabla creada correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al crear la tabla.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
        </div>
      </section>

      <section id="create-sqlite">
        <h4>Consultas en SQLite</h4>

        <p>En el caso de utiliza SQLite, no tiene sentido crear o borrar la base de datos ya que con SQLite cada base de datos es un fichero distinto y al conectar con la base de datos ya se dice con qué archivo se va a trabajar y se crea en caso necesario. Es suficiente borrar y crear las tablas.</p>

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE BORRADO DE TABLA EN SQLITE
$consulta = "DROP TABLE $tablaAgenda";
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Tabla borrada correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al borrar la tabla.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
        </div>

        <p>Para crear una tabla, se utiliza la consulta CREATE TABLE. Las consultas de creación de tabla suelen ser específicas de cada base de datos. El ejemplo no utiliza sentencias preparadas (en caso de utilizarse sentencias preparadas, las variables no podrían ir como parámetros por tratarse de sentencias DDL).</p>

        <div class="codigo">
          <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE CREACIÓN DE TABLA EN SQLite
$consulta = "CREATE TABLE $tablaAgenda (
    id INTEGER PRIMARY KEY,
    nombre VARCHAR($tamAgendaNombre),
    apellidos VARCHAR($tamAgendaApellidos)
    )";
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Tabla creada correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al crear la tabla.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
        </div>
      </section>

      <section id="create-configurable">
        <h4>Solución configurable</h4>

        <p>El resultado sería</p>
        <ul>
          <li>en el fichero que quiera reiniciar la base de datos se llamaría a la biblioteca general y se llamaría a la función genérica borraTodo():

            <div class="codigo">
              <pre>
<code class="language-php">// EJEMPLO DE USO DE CONEXIÓN CONFIGURABLE
// La conexión se debe realizar en cada página que acceda a la base de datos
require_once "biblioteca.php";
$db = conectaDb();
borraTodo($db, $tablaAgenda, $consultaCreaTabla);
$db = null;</code>
</pre>
            </div>
          </li>
          <li>biblioteca-mysql.php: contiene la definición de la función borraTodo() específica para trabajar con MySQL y que borra la base de datos, la crea y crea la tabla:

            <div class="codigo">
              <pre>
<code class="language-php">// biblioteca-mysql.php

// Consultas de borrado y creación de base de datos y tablas, etc.

define("CONSULTA_BORRA_DB", "DROP DATABASE " . MYSQL_DATABASE);

define(
    "CONSULTA_CREA_DB",
    "CREATE DATABASE " . MYSQL_DATABASE . "
        CHARACTER SET utf8mb4
        COLLATE utf8mb4_unicode_ci"
);

$consultaCreaTabla = "CREATE TABLE $tablaAgenda (
    id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
    nombre VARCHAR($tamAgendaNombre),
    apellidos VARCHAR($tamAgendaApellidos),
    PRIMARY KEY(id)
    )";

// Funciones específicas de bases de datos (MYSQL)

function borraTodo($db, $nombreTabla, $consultaCreacionTabla)
{
    $consulta = CONSULTA_BORRA_DB;
    if ($db-&gt;query($consulta)) {
        print "    &lt;p&gt;Base de datos borrada correctamente.&lt;/p&gt;\n";
        print "\n";
    } else {
        print "    &lt;p class=\"aviso\"&gt;Error al borrar la base de datos.&lt;/p&gt;\n";
        print "\n";
    }

    $consulta = CONSULTA_CREA_DB;
    if ($db-&gt;query($consulta)) {
        print "    &lt;p&gt;Base de datos creada correctamente.&lt;/p&gt;\n";
        print "\n";
        $consulta = $consultaCreacionTabla;
        if ($db-&gt;query($consulta)) {
            print "    &lt;p&gt;Tabla creada correctamente.&lt;/p&gt;\n";
            print "\n";
        } else {
            print "    &lt;p class=\"aviso\"&gt;Error al crear la tabla.&lt;/p&gt;\n";
            print "\n";
        }
    } else {
        print "    &lt;p class=\"aviso\"&gt;Error al crear la base de datos.&lt;/p&gt;\n";
        print "\n";
    }
}</code>
</pre>
            </div>
          </li>
          <li>biblioteca-sqlite.php: contiene la definición de la función borraTodo() específica para trabajar con SQLite y que borra la tabla y la crea:

            <div class="codigo">
              <pre>
<code class="language-php">// biblioteca-sqlite.php

// Consultas de borrado y creación de base de datos y tablas, etc.

$consultaCreaTabla = "CREATE TABLE $tablaAgenda (
    id INTEGER PRIMARY KEY,
    nombre VARCHAR($tamAgendaNombre),
    apellidos VARCHAR($tamAgendaApellidos)
    )";

// Funciones específicas de bases de datos (SQLITE)

function borraTodo($db, $nombreTabla, $consultaCreacionTabla)
{
    $consulta = "DROP TABLE $nombreTabla";
    if ($db-&gt;query($consulta)) {
        print "    &lt;p&gt;Tabla borrada correctamente.&lt;/p&gt;\n";
        print "\n";
    } else {
        print "    &lt;p class=\"aviso\"&gt;Error al borrar la tabla.&lt;/p&gt;\n";
        print "\n";
    }

    $consulta = $consultaCreacionTabla;
    if ($db-&gt;query($consulta)) {
        print "    &lt;p&gt;Tabla creada correctamente.&lt;/p&gt;\n";
        print "\n";
    } else {
        print "    &lt;p class=\"aviso\"&gt;Error al crear la tabla.&lt;/p&gt;\n";
        print "\n";
    }
}</code>
</pre>
            </div>
          </li>
        </ul>
      </section>
    </section>

    <section id="drop">
      <h3>Consultas DROP TABLE, INSERT INTO, UPDATE, DELETE FROM</h3>

      <p>Para borrar una tabla, se utiliza la consulta DROP TABLE.</p>

      <div class="codigo">
        <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE BORRADO DE TABLA
$consulta = "DROP TABLE $tablaAgenda";
if ($db-&gt;query($consulta)) {
    print "    &lt;p&gt;Tabla borrada correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al borrar la tabla.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
      </div>

      <hr class="corta">

      <p>Para añadir un registro a una tabla, se utiliza la consulta INSERT INTO.</p>

      <div class="codigo">
        <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE INSERCIÓN DE REGISTRO
$nombre    = recoge("nombre");
$apellidos = recoge("apellidos");

$consulta = "INSERT INTO $tablaAgenda
    (nombre, apellidos)
    VALUES (:nombre, :apellidos)";
$result = $db-&gt;prepare($consulta);
if ($result-&gt;execute([":nombre" =&gt; $nombre, ":apellidos" =&gt; $apellidos])) {
    print "    &lt;p&gt;Registro creado correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al crear el registro.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
      </div>

      <hr class="corta">

      <p>Para modificar un registro a una tabla, se utiliza la consulta UPDATE.</p>

      <div class="codigo">
        <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE MODIFICACIÓN DE REGISTRO
$nombre    = recoge("nombre");
$apellidos = recoge("apellidos");
$id        = recoge("id");

$consulta = "UPDATE $tablaAgenda
    SET nombre=:nombre, apellidos=:apellidos
    WHERE id=:id";
$result = $db-&gt;prepare($consulta);
if ($result-&gt;execute([":nombre" =&gt; $nombre, ":apellidos" =&gt; $apellidos, ":id" =&gt; $id])) {
    print "    &lt;p&gt;Registro modificado correctamente.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p class=\"aviso\"&gt;Error al modificar el registro.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
      </div>

      <hr class="corta">

      <p>Para borrar un registro de una tabla, se utiliza la consulta DELETE FROM.</p>

      <p><strong>Nota</strong>: En el ejemplo, los registros a borrar se reciben en forma de matriz y se recorre la matriz borrando un elemento en cada iteración.</p>

      <div class="codigo">
        <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE BORRADO DE REGISTRO
$id = recoge("id", []);

foreach ($id as $indice =&gt; $valor) {
    $consulta = "DELETE FROM $tablaAgenda
        WHERE id=:indice";
    $result = $db-&gt;prepare($consulta);
    if ($result-&gt;execute([":indice" =&gt; $indice])) {
        print "    &lt;p&gt;Registro borrado correctamente.&lt;/p&gt;\n";
        print "\n";
    } else {
        print "    &lt;p class=\"aviso\"&gt;Error al borrar el registro.&lt;/p&gt;\n";
        print "\n";
    }
}</code>
</pre>
      </div>
    </section>

    <section id="select">
      <h3>Consulta SELECT</h3>

      <p>Para obtener registros que cumplan determinados criterios se utiliza una consulta SELECT.</p>
      <ul>
        <li>Si se produce un error en la consulta, la consulta devuelve el valor <span class="php-con">false</span> .

          <div class="codigo">
            <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$consulta = "SELECT * FROM $tablaAgenda";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"p&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p&gt;Consulta ejecutada.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
          </div>
        </li>
        <li>Si la consulta devuelve un único registro se puede utilizar la función <a href="https://www.php.net/manual/en/pdostatement.fetchcolumn.php">PDOStatement-&gt;fetchColumn()</a> para recuperar la primera columna.

          <div class="codigo">
            <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$consulta = "SELECT COUNT(*) FROM $tablaAgenda";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
    $encontrados = $result-&gt;fetchColumn();
    print "    &lt;p&gt;Se han encontrado $encontrados registros.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
          </div>
        </li>
        <li>Si la consulta se ejecuta correctamente, la consulta devuelve los registros correspondientes. <br>

          <ul>
            <li>Para acceder a los registros devueltos por la consulta, se puede utilizar un bucle foreach.

              <div class="codigo">
                <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$consulta = "SELECT * FROM $tablaAgenda";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
    foreach ($result as $valor) {
        print "    &lt;p&gt;Nombre: $valor[nombre] - Apellidos: $valor[apellidos]&lt;/p&gt;\n";
        print "\n";
    }
}</code>
</pre>
              </div>
            </li>
            <li>O también se puede utilizar la función <a href="https://www.php.net/manual/en/pdostatement.fetch.php"><span class="php-fun">PDOStatement-&gt;fetch()</span></a>.

              <div class="codigo">
                <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$consulta = "SELECT * FROM $tablaAgenda";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
    while ($valor = $result-&gt;fetch()) {
        print "    &lt;p&gt;Nombre: $valor[nombre] - Apellidos: $valor[apellidos]&lt;/p&gt;\n";
        print "\n";
    }
}</code>
</pre>
              </div>
            </li>
          </ul>
        </li>
        <li>Si la consulta no devuelve ningún registro, los dos bucles anteriores (foreach o fetch) no escribirían nada. Por ello se recomienda hacer primero una consulta que cuente el número de resultados de la consulta y, si es mayor que cero, hacer la consulta.

          <p>El ejemplo siguiente utiliza la función <a href="https://www.php.net/manual/en/pdostatement.fetchcolumn.php"><span class="php-fun">PDOStatement-&gt;fetchColumn()</span></a>, que devuelve la primera columna del primer resultado (que en este caso contiene el número de registros de la consulta).</p>

          <div class="codigo">
            <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$consulta = "SELECT COUNT(*) FROM $tablaAgenda";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} elseif ($result-&gt;fetchColumn() == 0) {
    print "    &lt;p&gt;No se ha creado todavía ningún registro en la tabla.&lt;/p&gt;\n";
    print "\n";
} else {
    $consulta = "SELECT * FROM $tablaAgenda";
    $result = $db-&gt;query($consulta);
    if (!$result) {
        print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
        print "\n";
    } else {
        foreach ($result as $valor) {
            print "    &lt;p&gt;Nombre: $valor[nombre] - Apellidos: $valor[apellidos]&lt;/p&gt;\n";
            print "\n";
        }
    }
}</code>
</pre>
          </div>
        </li>
      </ul>
    </section>

    <section id="select-like">
      <h3>Consulta SELECT LIKE</h3>

      <p>La consulta SELECT permite efectuar búsquedas en cadenas utilizando el condicional LIKE o NOT LIKE y los comodines _ (cualquier carácter) o % (cualquier número de caracteres).</p>

      <p>Ejemplos de consultas:</p>
      <ul>
        <li>Registros en los que el apellido empieza por la cadena recibida:

          <div class="codigo">
            <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$apellidos = recoge("apellidos");

$consulta = "SELECT COUNT(*) FROM $tablaAgenda
    WHERE apellidos LIKE :apellidos";
$result = $db-&gt;prepare($consulta);
$result-&gt;execute([":apellidos" =&gt; "<span class="codigo-resaltado">$apellidos%</span>"]);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p&gt;Se han encontrado {$result-&gt;fetchColumn()} registros.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
          </div>
        </li>
        <li>Registros en los que el apellido contiene la cadena recibida:

          <div class="codigo">
            <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE SELECCIÓN DE REGISTROS
$apellidos = recoge("apellidos");

$consulta = "SELECT COUNT(*) FROM $tablaAgenda
    WHERE apellidos LIKE :apellidos";
$result = $db-&gt;prepare($consulta);
$result-&gt;execute([":apellidos" =&gt; "<span class="codigo-resaltado">%$apellidos%</span>"]);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
    print "    &lt;p&gt;Se han encontrado {$result-&gt;fetchColumn()} registros.&lt;/p&gt;\n";
    print "\n";
}</code>
</pre>
          </div>
        </li>
      </ul>
    </section>

    <section id="union-tablas">
      <h3>Consultas de unión de tablas</h3>

      <p>Se pueden también realizar consultas de unión entre varias tablas (el ejemplo está sacado del <a href="../ejercicios/bases-de-datos-viejos/biblioteca-1.html">ejercicio de Biblioteca</a>):</p>

      <p class="incompleto"><strong>Nota</strong>: Escribir como consulta preparada.</p>

      <div class="codigo">
        <pre>
<code class="language-php">// EJEMPLO DE CONSULTA DE UNIÓN DE TABLAS
$consulta = "SELECT $dbPrestamos.id AS id, $dbUsuarios.nombre as nombre,
    $dbUsuarios.apellidos as apellidos, $dbObras.titulo as titulo,
    $dbPrestamos.prestado as prestado, $dbPrestamos.devuelto as devuelto
    FROM $dbPrestamos, $dbUsuarios, $dbObras
    WHERE $dbPrestamos.id_usuario=$dbUsuarios.id AND
    $dbPrestamos.id_obra=$dbObras.id and $dbPrestamos.devuelto='0000-00-00'
    ORDER BY $columna $orden";
$result = $db-&gt;query($consulta);
if (!$result) {
    print "    &lt;p class=\"aviso\"&gt;Error en la consulta.&lt;/p&gt;\n";
    print "\n";
} else {
   ...</code>
</pre>
      </div>
    </section>
  </section>

  <footer>
    <p class="ultmod">Última modificación de esta página: 19 de mayo de 2020</p>

    <p class="licencia">
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.es_ES"><img src="../varios/iconos/icono-cc-by-sa.svg" alt="Licencia Creative Commons" title="Licencia Creative Commons BY-SA" width="120" height="42"></a><br>
      Esta página forma parte del curso <strong><a href="https://www.mclibre.org/consultar/php/">Programación web en PHP</a></strong> por <a href="https://www.mclibre.org/" rel="author">Bartolomé Sintes Marco</a><br>
      que se distribuye bajo una <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.es_ES">Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)</a>.
    </p>
  </footer>
</body>
</html>
